{% extends "base.html" %} {% block head_scripts %}
<link
  rel="stylesheet"
  type="text/css"
  href="{{ url_for('static', filename='agora_rtm/index.css') }}"
/>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.7.0.js"></script>
<script src="{{ url_for('static', filename='agora_rtm/agora-rtm.js') }}"></script>
{% endblock head_scripts %} {% block content%}
<div id="app">
  <div class="container my-5">
    <div class="row">
      <div class="col" v-if="isLoggedIn">
        <div class="btn-group" role="group" id="btnGroup">
          <!-- If the current user is not an admin then show only admin -->
          {% if current_user['email'] != "admin@gmail.com" %} 
            {% for singleUser in allUsers %} 
            <!-- If the user is not the current user and is an admin they display info -->
              {% if singleUser['email'] == "admin@gmail.com" and singleUser['id'] != current_user['id'] %}
                {% set username = singleUser['username']%}
                <button
                  type="button"
                  class="btn btn-primary mr-2 my-2"
                  @click="placeCall('{{username}}')"
                >
                  Call {{ username}}
                  <span class="badge badge-light">
                    ${updatedOnlineStatus?.["{{username}}"]?.toLowerCase() || 'offline'}
                  </span>
                </button>
                <button type="button" v-if="callEnded" data-toggle="modal" data-target="#feedbackModal" class="btn btn-info mr-2 my-2">
                  Close Dispute
                </button>


                <button type="button" data-toggle="modal" data-target="#emailModal" class="btn btn-info mr-2 my-2">
                  Email Us!
                </button>


                {% endif %}
            {% endfor %}
          {% endif %} 
        </div>
      </div>
    </div>

    <div class="row my-5" v-if="isCallingUser">
      <div class="col-12">
        <p>${callingUserNotification}</p>
        <button type="button" class="btn btn-danger" @click="cancelCall">
          Cancel Call
        </button>
      </div>
    </div>

    <!-- Incoming Call  -->
    <div class="row my-5" v-if="incomingCall">
      <div class="col-12">
        <!-- <p>Incoming Call From <strong>${ incomingCaller }</strong></p> -->
        <p>${incomingCallNotification}</p>
        <div class="btn-group" role="group">
          <button
            type="button"
            class="btn btn-danger"
            data-dismiss="modal"
            @click="declineCall"
          >
            Decline
          </button>
          <button
            type="button"
            class="btn btn-success ml-5"
            @click="acceptCall"
          >
            Accept
          </button>
        </div>
      </div>
    </div>
    <!-- End of Incoming Call  -->
  </div>

  <section id="video-container" v-if="callPlaced">
    <div id="local-video" ref="localVideo"></div>
    <div id="remote-video" ref="remoteVideo"></div>

    <div class="action-btns">
      <button type="button" class="btn btn-info" @click="handleAudioToggle">
        ${ mutedAudio ? "Unmute" : "Mute" }
      </button>
      <button
        type="button"
        class="btn btn-primary mx-4"
        @click="handleVideoToggle"
      >
        ${ mutedVideo ? "ShowVideo" : "HideVideo" }
      </button>
      <button type="button" class="btn btn-danger" @click="endCall">
        EndCall
      </button>
    </div>
  </section>
</div>


<!-- Modal for email -->
<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">

      <div class="modal-header">
        <h3>Email us!</h3>

      </div>
      
        <form onsubmit="sendMail(); return false;" class="row g-3">
          <div class="col-12">
            <label for="subject">Subject:</label>
            <input type="text" id="subject" required><br><br>
          </div>

          <div class="col-12">
            <label for="body">Body:</label><br>
            <textarea id="body" rows="10" cols="50" required></textarea><br><br>
          </div>
          
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="gridCheck">
              <label class="form-check-label" for="gridCheck">
                ESD Sanity Check
              </label>
            </div>
          </div>

          <div class="col-12">

            <button type="submit">Send</button>
          </div>
        </form>


     
    </div>
  </div>
</div>




<!-- Modal for feedback-->
<div class="modal fade" id="feedbackModal" tabindex="-1" role="dialog" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">Dispute Resolved?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form id="feedback-form">
      <div class="modal-body">
      
        <label>
          <input type="checkbox" name=""> ESD Sanity Check
        </label>
        
        <!-- If Resolved -->
        <button type="button" onclick="closeWindow()" class="btn btn-secondary" id="yesBtn" data-dismiss="modal">Yes</button>
        
        <!-- If Not Resolved -->
        <a href="http://127.0.0.1:5450/pRefund">
          <button type="submit" class="btn btn-primary" id="noBtn">No</button>
        </a>

      </div>
  
      </form>
    </div>
  </div>
</div>
{% endblock content %}

<!-- Add Scripts -->
{% block bottom_scripts%}
<script>
  const AUTH_USER = "{{current_user['username']}}";
  const AUTH_USER_ID = "{{current_user['id']}}";
  const CSRF_TOKEN = "{{ csrf_token }}";
  const AGORA_APP_ID = "{{agoraAppID}}";
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="{{ url_for('static', filename='agora_rtm/index.js') }}"></script>
<script>
  // const config = {
  //   headers: {
  //     'Content-Type': 'application/x-www-form-urlencoded'
  //   }
  // };

  // const submitForm = async (event) => {
  //   event.preventDefault();
  //   const formData = new FormData(event.target);
  //   const data = {};
  //   formData.forEach((value, key) => data[key] = value);
  //   try {
  //     console.log(data)
  //     const response = await axios.post('/feedback/create', data, config);
  //       document.getElementById("feedback-fail").style.display = "none";
  //       document.getElementById("feedback-success").style.display = "block";
  //       setTimeout(() => {
  //         location.reload();
  //       }, 2000);
  //     console.log(response);
  //   } catch (error) {
  //     console.error(error);
  //     document.getElementById("feedback-success").style.display = "none";
  //     document.getElementById("feedback-fail").style.display = "block";
  //   }
  // }
  
  // // Attach submitForm function to your form's submit event listener
  // document.querySelector('#feedback-form').addEventListener('submit', submitForm);

  function sendMail() {
			const to = ('poolpalesd@gmail.com');
			const subject = document.getElementById('subject').value;
			const body = document.getElementById('body').value;
			window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;
		}

  function closeWindow() {
    window.close();
  }
</script>
{% endblock bottom_scripts %}
